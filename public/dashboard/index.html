<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShopPulseAI Dashboard</title>
  <link rel="preconnect" href="https://cdn.shopify.com/">
  <link rel="stylesheet" href="https://cdn.shopify.com/static/fonts/inter/v4/styles.css">
  <!-- Shopify Polaris styles -->
  <link rel="stylesheet" href="https://unpkg.com/@shopify/polaris@10.49.1/build/esm/styles.css" />
  <!-- App Bridge -->
  <script src="https://unpkg.com/@shopify/app-bridge@3.7.9"></script>
  <script src="https://unpkg.com/@shopify/app-bridge-utils@3.5.1"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      background-color: #f6f6f7;
      color: #202223;
      line-height: 1.6;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    h1 {
      font-size: 1.8rem;
      margin: 0;
      color: #008060;
    }
    .dashboard-content {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.2rem;
      color: #008060;
    }
    .back-link {
      display: inline-block;
      margin-top: 1rem;
      color: #008060;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    #auth-required {
      display: none;
      text-align: center;
      padding: 2rem;
      background-color: #fff;
      border-radius: 8px;
      margin: 2rem auto;
      max-width: 600px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .loading {
      text-align: center;
      padding: 2rem;
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <p>Initialisiere ShopPulseAI...</p>
  </div>

  <div id="auth-required" style="display: none;">
    <h2>Authentifizierung erforderlich</h2>
    <p>Bitte autorisieren Sie ShopPulseAI, um auf Ihre Shop-Daten zuzugreifen.</p>
    <button id="auth-button" class="button" style="background-color: #008060; color: white; padding: 1rem 2rem; border-radius: 4px; border: none; cursor: pointer; font-weight: bold;">
      Autorisieren
    </button>
  </div>

  <div id="app-content" style="display: none;">
    <header>
      <h1>ShopPulseAI Dashboard</h1>
      <div>
        <span id="store-name">Loading...</span>
      </div>
    </header>

    <main>
      <div class="dashboard-content">
        <div class="card">
          <h2>Produktempfehlungen</h2>
          <p>Laden von KI-gestützten Produktempfehlungen...</p>
          <div id="recommendations-container"></div>
        </div>
        <div class="card">
          <h2>Preisoptimierung</h2>
          <p>Laden der Preisoptimierungsvorschläge...</p>
          <div id="price-optimize-container"></div>
        </div>
        <div class="card">
          <h2>Shop-Übersicht</h2>
          <p>Laden der Shop-Statistiken...</p>
          <div id="shop-stats-container"></div>
        </div>
      </div>

      <a href="../" class="back-link">← Zurück zur Startseite</a>
    </main>
  </div>

  <script>
    // App setup
    document.addEventListener('DOMContentLoaded', function() {
      // Wichtig: Immer den Shop-Parameter aus der URL holen
      const urlParams = new URLSearchParams(window.location.search);
      const shopDomain = urlParams.get('shop');
      
      if (!shopDomain) {
        // Redirect zum Install-Flow, wenn kein Shop-Parameter vorhanden ist
        console.log('Kein Shop-Parameter gefunden, weiterleiten zur Install-Seite');
        window.location.href = '/install';
        return;
      }
      
      // Versuche AppBridge zu initialisieren
      initializeAppBridge(shopDomain);
    });
    
    // Initialize Shopify App Bridge
    function initializeAppBridge(shop) {
      try {
        // Hole API key für die App Bridge
        // Dies sollte in einer Produktionsumgebung durch 
        // serverseitige Injektion erfolgen
        const apiKey = 'your-api-key'; // Ersetze mit deinem tatsächlichen API-Key
        
        console.log(`Initialisiere App Bridge für Shop: ${shop}`);
        
        // Initialisiere App Bridge
        const app = window['app-bridge'].createApp({
          apiKey: apiKey,
          host: shop,
          forceRedirect: true
        });
        
        // App Bridge Session Token holen
        window['app-bridge-utils'].getSessionToken(app)
          .then(token => {
            console.log('Session Token erhalten, verifiziere mit API');
            
            // Token im SessionStorage speichern
            sessionStorage.setItem('sessionToken', token);
            
            // Token mit unserer API verifizieren
            return verifySessionToken(token, shop);
          })
          .then(verified => {
            if (verified) {
              // Token ist gültig, Dashboard anzeigen
              document.getElementById('loading').style.display = 'none';
              document.getElementById('app-content').style.display = 'block';
              
              // Dashboard-Daten laden
              loadDashboardData(sessionStorage.getItem('sessionToken'), shop);
            } else {
              throw new Error('Session Token konnte nicht verifiziert werden');
            }
          })
          .catch(err => {
            console.error('Fehler mit Session Token:', err);
            
            // Auth-Required-Screen anzeigen
            document.getElementById('loading').style.display = 'none';
            document.getElementById('auth-required').style.display = 'block';
            
            // Auth-Button-Handler hinzufügen
            document.getElementById('auth-button').addEventListener('click', function() {
              window.location.href = `/api/auth?shop=${encodeURIComponent(shop)}`;
            });
          });
      } catch (error) {
        console.error('Fehler beim Initialisieren von App Bridge:', error);
        
        // Redirect zur Auth-Seite bei Fehler
        window.location.href = `/api/auth?shop=${encodeURIComponent(shop)}`;
      }
    }
    
    // Verify the session token with our API
    async function verifySessionToken(token, shop) {
      try {
        console.log('Verifiziere Session Token mit API');
        const response = await fetch('/api/verify-session', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'X-Shopify-Shop-Domain': shop
          }
        });
        
        if (response.ok) {
          console.log('Session Token erfolgreich verifiziert');
          return true;
        } else {
          console.error('Konnte Session Token nicht verifizieren:', await response.text());
          return false;
        }
      } catch (error) {
        console.error('Fehler bei der Verifizierung des Session Tokens:', error);
        return false;
      }
    }
    
    // Load dashboard data using session token
    function loadDashboardData(sessionToken, shop) {
      document.getElementById('store-name').textContent = shop;
      
      // Produkte mit Session Token abrufen
      fetch('/api/products', {
        headers: {
          'Authorization': `Bearer ${sessionToken}`,
          'X-Shopify-Shop-Domain': shop
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Konnte Produkte nicht laden');
        return response.json();
      })
      .then(products => {
        console.log('Produkte geladen:', products);
        // In einer echten App würden die Produkte hier angezeigt werden
      })
      .catch(error => {
        console.error('Fehler beim Laden der Produkte:', error);
      });
      
      // Empfehlungen mit Session Token abrufen
      fetch('/api/recommendations', {
        headers: {
          'Authorization': `Bearer ${sessionToken}`,
          'X-Shopify-Shop-Domain': shop
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Konnte Empfehlungen nicht laden');
        return response.json();
      })
      .then(recommendations => {
        console.log('Empfehlungen geladen:', recommendations);
        
        // Empfehlungen anzeigen
        const html = recommendations.map(rec => `
          <div style="margin-bottom: 1rem;">
            <strong>Produkt ${rec.product_id}:</strong> ${rec.suggestion}
            <div style="font-size: 0.9rem; color: #6d7175;">Konfidenz: ${(rec.confidence * 100).toFixed(0)}%</div>
          </div>
        `).join('');
        
        document.getElementById('recommendations-container').innerHTML = html || 
          '<p>Keine Empfehlungen verfügbar. Verbinden Sie Ihren Shop, um Vorschläge zu erhalten.</p>';
        
        document.getElementById('price-optimize-container').innerHTML = 
          '<p>Keine Preisvorschläge verfügbar. Verbinden Sie Ihren Shop, um Optimierungen zu erhalten.</p>';
        
        document.getElementById('shop-stats-container').innerHTML = 
          '<p>Keine Shop-Statistiken verfügbar. Verbinden Sie Ihren Shop, um Statistiken zu sehen.</p>';
      })
      .catch(error => {
        console.error('Fehler beim Laden der Empfehlungen:', error);
        document.getElementById('recommendations-container').innerHTML = 
          '<p>Fehler beim Laden der Empfehlungen. Bitte versuchen Sie es später erneut.</p>';
      });
    }
    
    // Helper function to get cookies
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
  </script>
  
  <script src="../app.js"></script>
</body>
</html> 